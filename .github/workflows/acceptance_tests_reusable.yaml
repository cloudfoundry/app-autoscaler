name: Acceptance Tests â€“ Reusable
on:
  workflow_call:
    inputs:
      suites:
        required: false
        type: string
        default: "[ 'api', 'app', 'broker' ]"
      deployment_name:
        required: true
        type: string
    secrets:
      bbl_ssh_key:
        required: true

defaults:
  run:
    shell: bash

env:
  PR_NUMBER: "${{ github.event.pull_request.number }}"
  DEPLOYMENT_NAME: "${{ inputs.deployment_name }}"
  BBL_STATE_PATH: "${{ github.workspace }}/bbl/bbl-state"
  GINKGO_OPTS: "--fail-fast"
  NODES: 4
  AUTOSCALER_DIR: "${{ github.workspace }}/app-autoscaler"
  CPU_UPPER_THRESHOLD: 200
  AUTOSCALER_TEST_USER: "autoscaler-test-user-${{ github.event.pull_request.number }}"

jobs:
  deploy_autoscaler:
    name: Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          path: app-autoscaler
      - name: Install devbox
        uses: jetify-com/devbox-install-action@a0d2d53632934ae004f878c840055956d9f741b0 # v0.14.0
        with:
          enable-cache: 'true'
          project-path: "${AUTOSCALER_DIR}"
      - name: Make devbox shellenv available
        run: |
          cd "${AUTOSCALER_DIR}"
          eval "$(devbox shellenv)"
          printenv >> "$GITHUB_ENV"
      - name: Setup environment for deployment
        uses: ./app-autoscaler/.github/actions/setup-environment
        with:
          ssh-key: ${{ secrets.bbl_ssh_key}}

      - name: Setup acceptance test user with OrgManager role
        shell: bash
        run: |
          make cf-login
          make setup-acceptance-user.sh

      - name: Provision DB
        shell: bash
        run: make --directory="${AUTOSCALER_DIR}" provision-db

      - name: Deploy Apps
        shell: bash
        run: |
          make --directory="${AUTOSCALER_DIR}" build-extension-file
          make --directory="${AUTOSCALER_DIR}" mta-build
          make --directory="${AUTOSCALER_DIR}" mta-deploy

      - name: Register autoscaler
        shell: bash
        run: make --directory="${AUTOSCALER_DIR}" deploy-register-cf

      - name: Enable service access (admin)
        shell: bash
        run: |
          cd "${AUTOSCALER_DIR}"
          source scripts/vars.source.sh
          source scripts/common.sh

          bbl_login
          cf_login
          cf_target "${AUTOSCALER_ORG}" "${AUTOSCALER_SPACE}"

          ./scripts/enable-service-access.sh "${DEPLOYMENT_NAME}"

  acceptance_tests:
    name: Acceptance Tests - ${{ matrix.suite }}
    needs: [ deploy_autoscaler ]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        suite: ${{ fromJson(inputs.suites) }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          path: app-autoscaler
      - name: Install devbox
        uses: jetify-com/devbox-install-action@a0d2d53632934ae004f878c840055956d9f741b0 # v0.14.0
        with:
          enable-cache: 'true'
          project-path: "${AUTOSCALER_DIR}"
      - name: Make devbox shellenv available
        run: |
          cd "${AUTOSCALER_DIR}"
          eval "$(devbox shellenv)"
          printenv >> "$GITHUB_ENV"
      - name: Setup environment for acceptance tests
        uses: ./app-autoscaler/.github/actions/setup-environment
        with:
          ssh-key: ${{ secrets.bbl_ssh_key}}
      - name: Set acceptance test environment variables
        shell: bash
        run: |
          cd "${AUTOSCALER_DIR}"
          source scripts/vars.source.sh
          source scripts/common.sh
          bbl_login

          AUTOSCALER_TEST_PASSWORD=$(credhub get --quiet --name="${CREDHUB_TEST_USER_PASSWORD_PATH}")

          {
            echo "USE_EXISTING_ORGANIZATION=true"
            echo "EXISTING_ORGANIZATION=${AUTOSCALER_ORG}"
            echo "AUTOSCALER_TEST_USER=${AUTOSCALER_TEST_USER}"
            echo "AUTOSCALER_TEST_PASSWORD=${AUTOSCALER_TEST_PASSWORD}"
            echo "SKIP_SERVICE_ACCESS_MANAGEMENT=true"
            echo "USE_EXISTING_USER=true"
            echo "EXISTING_USER=${AUTOSCALER_TEST_USER}"
            echo "EXISTING_USER_PASSWORD=${AUTOSCALER_TEST_PASSWORD}"
            echo "KEEP_USER_AT_SUITE_END=true"
            echo "ADD_EXISTING_USER_TO_EXISTING_SPACE=true"
          } >> $GITHUB_ENV
      - name: Run acceptance tests via CF tasks - ${{ matrix.suite }}
        shell: bash
        env:
          SUITES: ${{ matrix.suite }}
        run: make --directory="${AUTOSCALER_DIR}" mta-acceptance-tests

  deployment_cleanup:
    needs: [ deploy_autoscaler, acceptance_tests ]
    if: "!contains(github.event.pull_request.labels.*.name, 'skip-cleanup')"
    name: Cleanup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          path: app-autoscaler
      - name: Install devbox
        uses: jetify-com/devbox-install-action@a0d2d53632934ae004f878c840055956d9f741b0 # v0.14.0
        with:
          enable-cache: 'true'
          project-path: "${AUTOSCALER_DIR}"
      - name: Make devbox shellenv available
        run: |
          cd "${AUTOSCALER_DIR}"
          eval "$(devbox shellenv)"
          printenv >> "$GITHUB_ENV"
      - name: Setup environment for deployment cleanup
        uses: ./app-autoscaler/.github/actions/setup-environment
        with:
          ssh-key: ${{ secrets.bbl_ssh_key}}
      - name: Perform deployment cleanup
        run: |
          make --directory="${AUTOSCALER_DIR}" deploy-cleanup

  # This job will run and fail if any of the jobs it depends on fail or are cancelled.
  # It is an "ugly workaround" for an issue on GitHub Actions side, where
  # skipped jobs are considered successful.
  # See https://github.com/actions/runner/issues/2566#issuecomment-1523814835
  result:
      needs: acceptance_tests
      if: ${{ cancelled() || contains(needs.*.result, 'cancelled') || contains(needs.*.result, 'failure') }}
      name: Result
      runs-on: ubuntu-latest
      steps:
        - run: |
            echo "Some required workflows have failed!"
            exit 1
