name: Acceptance Tests â€“ Reusable
on:
  workflow_call:
    inputs:
      suites:
        required: false
        type: string
        default: "[ 'api', 'app', 'broker' ]"
      deployment_name:
        required: true
        type: string
    secrets:
      bbl_ssh_key:
        required: true

defaults:
  run:
    shell: bash

env:
  PR_NUMBER: "${{ github.event.pull_request.number }}"
  DEPLOYMENT_NAME: "${{ inputs.deployment_name }}"
  BBL_STATE_PATH: "${{ github.workspace }}/bbl/bbl-state"
  GINKGO_OPTS: "--fail-fast"
  NODES: 4
  AUTOSCALER_DIR: "${{ github.workspace }}/app-autoscaler"
  CPU_UPPER_THRESHOLD: 200

jobs:
  deploy_autoscaler:
    name: Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          path: app-autoscaler
      - name: Install devbox
        uses: jetify-com/devbox-install-action@a0d2d53632934ae004f878c840055956d9f741b0 # v0.14.0
        with:
          enable-cache: 'true'
          project-path: "${AUTOSCALER_DIR}"
      - name: Make devbox shellenv available
        run: |
          cd "${AUTOSCALER_DIR}"
          eval "$(devbox shellenv)"
          printenv >> "$GITHUB_ENV"
      - name: Setup environment for deployment
        uses: ./app-autoscaler/.github/actions/setup-environment
        with:
          ssh-key: ${{ secrets.bbl_ssh_key}}

      - name: Cleanup previous deployment
        shell: bash
        run: |
          make --directory="${AUTOSCALER_DIR}" deploy-cleanup || echo "Cleanup warnings expected if nothing exists"

      - name: Setup org manager user with OrgManager and SpaceDeveloper roles
        shell: bash
        run: |
          make --directory="${AUTOSCALER_DIR}" setup-org-manager-user

      - name: Provision DB
        shell: bash
        run: make --directory="${AUTOSCALER_DIR}" provision-db

      - name: Deploy Apps
        shell: bash
        run: |
          make --directory="${AUTOSCALER_DIR}" build-extension-file
          make --directory="${AUTOSCALER_DIR}" mta-build
          make --directory="${AUTOSCALER_DIR}" mta-deploy

      - name: Register autoscaler
        shell: bash
        run: make --directory="${AUTOSCALER_DIR}" register-broker

  acceptance_tests:
    name: Acceptance Tests - ${{ matrix.suite }}
    needs: [ deploy_autoscaler ]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        suite: ${{ fromJson(inputs.suites) }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          path: app-autoscaler
      - name: Install devbox
        uses: jetify-com/devbox-install-action@a0d2d53632934ae004f878c840055956d9f741b0 # v0.14.0
        with:
          enable-cache: 'true'
          project-path: "${AUTOSCALER_DIR}"
      - name: Make devbox shellenv available
        run: |
          cd "${AUTOSCALER_DIR}"
          eval "$(devbox shellenv)"
          printenv >> "$GITHUB_ENV"
      - name: Setup environment for acceptance tests
        uses: ./app-autoscaler/.github/actions/setup-environment
        with:
          ssh-key: ${{ secrets.bbl_ssh_key}}
      - name: Run acceptance tests via CF tasks - ${{ matrix.suite }}
        shell: bash
        env:
          SUITES: ${{ matrix.suite }}
        run: make --directory="${AUTOSCALER_DIR}" mta-acceptance-tests

  deployment_cleanup:
    needs: [ deploy_autoscaler, acceptance_tests ]
    if: "!contains(github.event.pull_request.labels.*.name, 'skip-cleanup')"
    name: Cleanup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          path: app-autoscaler
      - name: Install devbox
        uses: jetify-com/devbox-install-action@a0d2d53632934ae004f878c840055956d9f741b0 # v0.14.0
        with:
          enable-cache: 'true'
          project-path: "${AUTOSCALER_DIR}"
      - name: Make devbox shellenv available
        run: |
          cd "${AUTOSCALER_DIR}"
          eval "$(devbox shellenv)"
          printenv >> "$GITHUB_ENV"
      - name: Setup environment for deployment cleanup
        uses: ./app-autoscaler/.github/actions/setup-environment
        with:
          ssh-key: ${{ secrets.bbl_ssh_key}}
      - name: Perform deployment cleanup
        run: |
          make --directory="${AUTOSCALER_DIR}" deploy-cleanup

  # This job will run and fail if any of the jobs it depends on fail or are cancelled.
  # It is an "ugly workaround" for an issue on GitHub Actions side, where
  # skipped jobs are considered successful.
  # See https://github.com/actions/runner/issues/2566#issuecomment-1523814835
  result:
      needs: acceptance_tests
      if: ${{ cancelled() || contains(needs.*.result, 'cancelled') || contains(needs.*.result, 'failure') }}
      name: Result
      runs-on: ubuntu-latest
      steps:
        - run: |
            echo "Some required workflows have failed!"
            exit 1
